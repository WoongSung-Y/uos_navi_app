
require('dotenv').config();
const express = require('express');
const multer = require('multer');
const { exec } = require('child_process');
const cors = require('cors'); // CORS ì„¤ì •
const pool = require('./db'); // PostgreSQL DB ì—°ê²° ì„¤ì •
const path = require('path')
const app = express();
const fs = require('fs');
const axios = require('axios');
const { spawn } = require('child_process')

app.use(express.json());
app.use(cors({ origin: '*' }));

const upload = multer({
  storage: multer.diskStorage({
    destination: './View',
    filename: (req, file, cb) => {
      const originalName = req.body.filename || file.originalname;
      const filePath = path.join('./View', originalName);

	if (fs.existsSync(filePath)) {
		fs.unlinkSync(filePath);
}
      cb(null, originalName);
    }
  })
});

const apiClient = axios.create({
  baseURL: 'http://15.165.159.29:3000',
  timeout: 10000,
});
 
// ğŸ”¹ ë©”ëª¨ë¦¬ ì €ì¥ìš© multer ì¸ìŠ¤í„´ìŠ¤ ë”°ë¡œ ì„¤ì •
const memoryUpload = multer({ storage: multer.memoryStorage() });

// íŒŒì´ì¬ ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° 
async function analyzeIndoorImage(buffer, pressure) {
  return new Promise((resolve, reject) => {
    const py = spawn('python3', ['VPR.py', pressure.toString()]);

    let result = '';
    let error = '';

    py.stdout.on('data', data => result += data.toString());
    py.stderr.on('data', data => error += data.toString());

    py.on('close', code => {
      if (code !== 0 || error) return reject(error || 'Python ì˜¤ë¥˜');
      try {
        resolve(JSON.parse(result));
      } catch (e) {
        reject('JSON íŒŒì‹± ì‹¤íŒ¨: ' + result);
      }
    });

    py.stdin.write(buffer);
    py.stdin.end();
  });
}


// ğŸ”¹ ì‹¤ë‚´ ìœ„ì¹˜ ì¸ì‹ ì „ìš© ì—…ë¡œë“œ (íŒŒì¼ ì €ì¥ X)
app.post('/api/indoor_upload', memoryUpload.single('image'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤' });
    }

    const buffer = req.file.buffer;
    const originalName = req.file.originalname;
    const pressure = req.body.pressure ? parseFloat(req.body.pressure) : null;

    console.log(`ğŸ“¡ ì‹¤ë‚´ ìœ„ì¹˜ ì‚¬ì§„ ìˆ˜ì‹ : ${originalName} (${buffer.length} bytes), ê¸°ì••: ${pressure} hpa`);

    const result = await analyzeIndoorImage(buffer, pressure);

    return res.json({ message: 'ì‹¤ë‚´ ìœ„ì¹˜ ì‚¬ì§„ ìˆ˜ì‹  ì™„ë£Œ' });
  } catch (err) {
    console.error('âŒ ì—…ë¡œë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
    return res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});


app.post('/api/upload_image', upload.single('image'),(req,res) => {
     if (!req.file) {
	return res.status(400).json({error : 'íŒŒì¼ì—…ë¡œë“œx'});
	}

      res.json({ message : 'ì—…ë¡œë“œ ì„±ê³µ!', filePath: req.file.path});
});



app.get('/View_list', (req, res) => {
  const dir = path.join(__dirname, 'View');
  fs.readdir(dir, (err, files) => {
    if (err) return res.send('ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

    const images = files
      .filter(file => /\.(jpg|jpeg|png)$/i.test(file))
      .map(file => `<div><img src="/View/${file}" style="width:300px;margin:10px"/><p>${file}</p></div>`);

    res.send(`<h1>ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€</h1>${images.join('')}`);
  });
});


app.use('/View', express.static(path.join(__dirname, 'View')));

/**
 * 0. ì„œë²„ í˜ì´ì§€ í™•ì¸
 */

app.get('/', (req, res) => {
  res.send(`<h1> ë ˆì „ë“œ íƒ±íƒ±ë³¼!</h1>
            <p>ìŠ¹ì„ì´ê°€ ëŒ€êµ´ëŒ€êµ´ êµ´ëŸ¬ê°€ê³  ìˆìŠµë‹ˆë‹¤ .</p>

            <h2> API ëª©ë¡ </h2>
            <ul>
               <li><a href="/api/total_building">/api/total_building</a></li>
	       <li><a href="/api/nodes">/api/nodes</a></li>
               <li><a href="/api/all_edge?floor=1">/api/all_edge?floor=1</a></li>
	       <li><a href="/View_list">/View_list</a></li>
           </ul>


`); 
});



/**
 * 1. ê±´ë¬¼ ì™¸ê³½ ë°ì´í„° ì¡°íšŒ API
 */
app.get('/api/total_building', async (req, res) => {
  console.log('ìš”ì²­ëœ total_building ë°ì´í„°');

  try {
    const sql = `
      SELECT 
        id_0, 
        id,
        ST_AsGeoJSON(ST_Transform(geom, 4326)) AS geom_json,
	build_name,
	min_floor,
	max_floor
      FROM building
      WHERE geom IS NOT NULL;
    `;
    const result = await pool.query(sql);
    console.log('ì¿¼ë¦¬ ê²°ê³¼:', result.rows);
    res.json(result.rows);
  } catch (err) {
    console.error('DB ì—ëŸ¬:', err);
    res.status(500).send('DB ì—ëŸ¬');
  }
});

/**
 * 2. íŠ¹ì • ì¸µì˜ ê±´ë¬¼ ë‚´ë¶€ ë°ì´í„° ì¡°íšŒ API
 */
app.get('/api/buildings_in', async (req, res) => {
  const { floor, buildingId } = req.query;

  console.log('ìš”ì²­ëœ floor ê°’:', floor, 'ìš”ì²­ëœ buildingId:', buildingId);

  try {
    if (!floor || isNaN(Number(floor)) || !buildingId || isNaN(Number(buildingId))) {
      return res.status(400).json({ error: 'ìœ íš¨í•œ floor ê°’ê³¼ buildingIdê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }

    const sql = `
      SELECT 
        id_0, 
        ST_AsGeoJSON(ST_Transform(geom, 4326)) AS geom_json
      FROM building_in
      WHERE floor = $1 AND building_i = $2;
    `;

    const result = await pool.query(sql, [Number(floor), Number(buildingId)]);
    res.json(result.rows);
  } catch (err) {
    console.error('DB ì—ëŸ¬:', err);
    res.status(500).send('DB ì—ëŸ¬');
  }
});

/**
 * 3. ë…¸ë“œ ë°ì´í„° ì¡°íšŒ API (ì‹¤ë‚´Â·ì‹¤ì™¸ êµ¬ë¶„ í¬í•¨)
 */
app.get('/api/nodes', async (req, res) => {
  try {
    const sql = `
      SELECT node_id, ST_X(st_transform(geom,4326)) AS longitude, ST_Y(st_transform(geom,4326)) AS latitude,
	     type , lect_num , transit , node_att , bulid_name , RealView, floor
      FROM node where node_att != 6 ;
    `;
    const result = await pool.query(sql);
    console.log("ğŸ“¡ DBì—ì„œ ê°€ì ¸ì˜¨ ë…¸ë“œ ë°ì´í„°:", result.rows); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

    if (result.rows.length === 0) {
      console.error("âŒ [DB ë¬¸ì œ] ë…¸ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return res.status(500).json({ error: "ë°ì´í„° ì—†ìŒ: nodes í…Œì´ë¸”ì´ ë¹„ì–´ ìˆìŒ" });
    }

    console.log("âœ… ë…¸ë“œ ë°ì´í„° ì¡°íšŒ ì„±ê³µ:", result.rows.length, "ê°œ");
    res.json(result.rows);
  } catch (err) {
    console.error("âŒ [DB ì˜¤ë¥˜] ë…¸ë“œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:", err);
    res.status(500).json({ error: "DB ì—ëŸ¬ ë°œìƒ", details: err.message });
  }
});

/**
 * 4. ìµœë‹¨ ê²½ë¡œ íƒìƒ‰ API (ì‹¤ë‚´Â·ì‹¤ì™¸ êµ¬ë¶„ ì ìš©)
 */
app.get('/api/shortest_path', async (req, res) => {
  const { startNode, endNode } = req.query;

  if (!startNode || !endNode) {
    return res.status(400).json({ error: 'ì¶œë°œ ë…¸ë“œ, ë„ì°© ë…¸ë“œ, ê²½ë¡œ íƒ€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
  }

  // ì‹¤ë‚´Â·ì‹¤ì™¸ êµ¬ë¶„í•˜ì—¬ ë§í¬ ë°ì´í„° ì ìš©
  const query = `
  SELECT * FROM pgr_dijkstra(
    'SELECT L.id, L.node1::integer AS source, L.node2::integer AS target, L.length::double precision AS cost 
     FROM link as L
     JOIN node AS N1 ON L.node1 = N1.node_id
     JOIN node AS N2 ON L.node2 = N2.node_id
     WHERE N1.node_att != 6 and N2.node_att != 6', 
     $1::integer, $2::integer, false
  ) ORDER BY agg_cost;
`;

try {
  console.log("ğŸ“ ì‹¤í–‰í•  SQL ì¿¼ë¦¬:", query);
  console.log("ğŸ“Œ ì „ë‹¬í•  íŒŒë¼ë¯¸í„°:", Number(startNode), Number(endNode));

  const result = await pool.query(query, [Number(startNode), Number(endNode)]);

  console.log("âœ… ì¿¼ë¦¬ ê²°ê³¼:", result.rows);
  // ğŸ“Œ ê²°ê³¼ë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜
  res.json(result.rows);

} catch (err) {
  console.error("âŒ ì¿¼ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:", err);
}})



/**
 * 5. ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° MATLAB ì²˜ë¦¬ API
 */
app.post('/api/upload', upload.single('image'), (req, res) => {
  const imagePath = req.file.path;
  const dataFilePath = process.env.MATLAB_DATA_PATH;
  const matlabPath = `"C:\\Program Files\\MATLAB\\R2024a\\bin\\matlab.exe"`;
  const matlabScriptPath = './matlab';

  console.log('MATLAB ì²˜ë¦¬í•  ì´ë¯¸ì§€ ê²½ë¡œ:', imagePath);
  console.log('MATLAB ì²˜ë¦¬í•  ë°ì´í„° íŒŒì¼ ê²½ë¡œ:', dataFilePath);

  console.time('MATLAB Execution');
  exec(
    `${matlabPath} -batch "addpath('${matlabScriptPath}'); processImage('${imagePath}', '${dataFilePath}')"`,
    (err, stdout, stderr) => {
      console.timeEnd('MATLAB Execution');
      if (err) {
        console.error('MATLAB ì‹¤í–‰ ì—ëŸ¬:', stderr);
        return res.status(500).json({ message: 'MATLAB ì²˜ë¦¬ ì‹¤íŒ¨', error: stderr });
      }

      console.log('MATLAB stdout:', stdout);

      try {
        const result = JSON.parse(stdout.trim());
        res.json(result);
      } catch (parseError) {
        console.error('MATLAB ê²°ê³¼ íŒŒì‹± ì—ëŸ¬:', parseError);
        res.status(500).json({ message: 'MATLAB ê²°ê³¼ íŒŒì‹± ì‹¤íŒ¨', error: parseError.message });
      }
    }
  );
});

/**
  * 6. ìµœë‹¨ê²½ë¡œ edge ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸°
**/
app.get('/api/edge_coordinates', async (req, res) => {
  const { edgeIds } = req.query;

  if (!edgeIds) {
    return res.status(400).json({ error: 'Edge ID ëª©ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
  }

  const edgeIdArray = edgeIds.split(',').map(id => Number(id)).filter(id => !isNaN(id));

  if (edgeIdArray.length === 0) {
    return res.status(400).json({ error: 'ìœ íš¨í•œ Edge IDê°€ ì—†ìŠµë‹ˆë‹¤.' });
  }

  const query = `
    SELECT id, ST_AsGeoJSON(st_transform(geom,4326)) as geom_json , floor, buildname
    FROM link
    WHERE id = ANY($1)
    ORDER BY ARRAY_POSITION($1, id); -- ğŸ”¥ Edge ID ìˆœì„œ ìœ ì§€
  `;

  try {
    console.log("ğŸ›£ï¸ ìš”ì²­í•œ Edge ID ë¦¬ìŠ¤íŠ¸:", edgeIdArray);
    const result = await pool.query(query, [edgeIdArray]);

    if (result.rows.length === 0) {
      console.warn("âš ï¸ ìš”ì²­í•œ Edge ì¤‘ì—ì„œ DBì— ì¡´ì¬í•˜ëŠ” Edgeê°€ ì—†ìŠµë‹ˆë‹¤.");
      return res.json([]);
    }

    const edges = result.rows.map(row => {
      const geoJson = JSON.parse(row.geom_json);

      // ğŸ”¥ MultiLineStringì´ë©´ `.flat()` ì‚¬ìš©í•´ì„œ 1ì°¨ì› ë°°ì—´ë¡œ ë³€í™˜
      const coordinates = geoJson.type === "MultiLineString"
        ? geoJson.coordinates.flat()
        : geoJson.coordinates;

      return {
        id: row.id,
        coordinates: coordinates,
	floor : row.floor,
	buildname : row.buildname
      };
    });

    console.log("âœ… GeoJSON ê¸°ë°˜ Edge ë°ì´í„° ë°˜í™˜:", JSON.stringify(edges, null, 2));
    res.json(edges);
  } catch (err) {
    console.error("âŒ Edge ì¢Œí‘œ ì¡°íšŒ ì‹¤íŒ¨:", err);
    res.status(500).json({ error: "DB ì—ëŸ¬ ë°œìƒ", details: err.message });
  }
});
/**
  * 7. ëª¨ë“  edge ì •ë³´ ë‚˜íƒ€ë‚´ê¸°
**/
app.get('/api/all_edge', async (req, res) => {
  const { floor } = req.query;
  let result;

  try {
    if (floor) {
      const query = `
        SELECT id,node1,node2, ST_AsGeoJSON(st_transform(geom, 4326)) as geom_json
        FROM link
        WHERE floor = $1
      `;
      result = await pool.query(query, [Number(floor)]);
    } else {
      const query = `
        SELECT id,node1,node2, ST_AsGeoJSON(st_transform(geom, 4326)) as geom_json
        FROM link
        WHERE type = 'outdoor'
      `;
      result = await pool.query(query);
    }

    const edges = result.rows.map(row => {
      const geoJson = JSON.parse(row.geom_json);
      const coordinates =
        geoJson.type === 'MultiLineString'
          ? geoJson.coordinates.flat()
          : geoJson.coordinates;

      return {
        id: row.id,
        coordinates,
	node1 : row.node1,
	node2 : row.node2
      };
    });

    res.json(edges);
  } catch (error) {
    console.error('ğŸš¨ ëª¨ë“  Edge ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    res.status(500).json({ error: 'ì„œë²„ ì˜¤ë¥˜' });
  }
});

/** 
  * 8. ê²½ë¡œì— ë§ëŠ” ì´ë¯¸ì§€ ë¿Œë¦¬ê¸°
**/
app.use('/images', express.static(path.join(__dirname, 'View')));


/**
 * 9. ì„œë²„ ì‹¤í–‰
 */
const PORT = process.env.PORT || 3000;
app.listen(PORT,'0.0.0.0', () => {
});
